---
title: "Updated_Axial_NMDS_permanova"
author: "Alexis Adams"
date: "2025-09-05"
output: html_document
---
##Making an NMDS plot for compiled Axial Seamount data

NMDS plots are non-metric and are thus ideal to use for data that may not fit a normal distribution. NMDS is an iterative algorithm, meaning it repeats the same steps until it finds the best fit. Since NMDS plots are non-metric actual distances are not preserved. Instead, distances are based on similarity only. The closer the points/samples are, the more similar the community. 

NMDS plot is generated using an OTU table where the points are the samples.An NMDS plot requires distance matrix as an input. For this plot, the distance matrix is Bray-Curtis because it takes into account both presence/absence and abundance. 

For more information on NMDS plots: https://sites.google.com/site/mb3gustame/dissimilarity-based-methods/non-metric-multidimensional-scaling

#Install packages and import data
Read in ASV/OTU table that has ASVs/OTUs as columns, and samples as rows. 

My current dataframe is a wide ASV table, with the first column being the ASVs and each column being a sample. I need to transpose the data so that the first column is a list of the samples and the following columns are ASVs. 
If there is metadata within the dataframe, remove it so that this data frame only includes ASV abundance columns. The input matrix for the NMDS can only contain numeric data. Make sure all data is numeric and that there are no empty rows. 

Once your data frame is in the proper format, save as a matrix. 
```{r}
install.packages("vegan")
install.packages("tidyverse")
install.packages("ggplot2")
library(vegan)
library(tidyverse)
library(ggplot2)

#import metadata table
metadata_input <- read_csv("R/Axial2023/datainput/axial_compiledmetadata_revised_samplestokeep.csv")


ASV <- read.delim("C:/Users/alexis98adams/Documents/R/Axial2023/datainput/clean_ASV.tsv", header = TRUE, sep = "\t")

#Remove samples that shouldn't be included in the analysis
axial_asv <- ASV %>% column_to_rownames("FeatureID") %>% t() %>% as.data.frame() %>% rownames_to_column("sample") %>% filter(sample %in% metadata_input$NEW_FASTQ_NAME)

unique(axial_asv$sample)

metadata_input <- metadata_input %>% rename(sample = NEW_FASTQ_NAME)

axial_asv_matrix <- axial_asv %>% filter(rowSums(select(., -sample)) >0) %>% select(-sample) %>% mutate_all(as.numeric) %>% as.matrix()
```

Now we can run the metaMDS command from the vegan package to generate an NMDS plot. The tutorial kept the parameters as default and set "bray" as the distance measure. To get the same results each time the NMDS plot is run include set.seed before metamDS command. 

```{r}
axial_nmds = metaMDS(axial_asv_matrix, distance = "bray")
plot(axial_nmds)
```
Stars represent species and circles represent samples. The plot is very crowded so exporting data from the NMDS scores (x and y coordinates) into a dataframe will allow plotting in ggplot. Import metadata into dataframe. I'm going to start by adding the sample names back from axial_asv so that I can left join with my metadata table. 

```{r}
axial.nmds.scores = as.data.frame(scores(axial_nmds)$sites)

axial.nmds.scores$sample = axial_asv$sample

##Lost a sample because sample 103 had zero asvs. Find sample and remove. 

check_axial_asvs <- axial_asv %>% mutate(row_sum = rowSums(select(., -sample))) %>% 
  filter(row_sum != 0)

axial.nmds.scores$sample = check_axial_asvs$sample

unique(metadata_input$Location_Name)

#
metadata_input <- metadata_input %>%  mutate(assoc_vent = case_when(
    (Location_Name == "ASHES") ~ "ASHES Plume",
    (Location_Name == "International District") ~ "International District Plume",
    (Location_Name == "Diva") ~ "International District Vent",
    (Location_Name == "Gollum") ~ "ASHES Vent",
    (Location_Name == "Marker 33") ~ "International District Vent",
    (Location_Name == "Marker 113") ~ "International District Vent",
    (Location_Name == "Anemone") ~ "ASHES Vent",
    (Location_Name == "Background") ~ "Background",
    (Location_Name == "Bag City") ~ "International District Vent",
    (Location_Name == "Vixen") ~ "International District Vent"))


axial_metadata_nmds <- left_join(axial.nmds.scores, metadata_input, by = "sample")

```

#NMDS Plot

```{r}

ggplot(axial_metadata_nmds, aes(x = NMDS1, y = NMDS2)) +
  geom_point(size = 4, aes(colour = assoc_vent)) +
    theme(axis.text.y = element_text(colour = "black", size = 12, face = "bold"),
        axis.text.x = element_text(colour = "black", face = "bold", size = 12), 
        legend.text = element_text(size = 12, face ="bold", colour ="black"), 
        legend.position = "right", axis.title.y = element_text(face = "bold", size = 14), 
        axis.title.x = element_text(face = "bold", size = 14, colour = "black"), 
        legend.title = element_text(size = 14, colour = "black", face = "bold"), 
        panel.background = element_blank(), 
        panel.border = element_rect(colour = "black", fill = NA, linewidth = 1.2),
        legend.key=element_blank()) + 
  labs(x = "NMDS1", colour = "Location Name", y = "NMDS2", shape = "Type")

```

#PERMANOVA test on ASHES plume

Permanova tests if community composition differs among categorical groups by testing statistical differences between categories. In this case, I hope to test the stastical differences between euk communities within the distinct plume categories.

Tutorial followed: https://uw.pressbooks.pub/appliedmultivariatestatistics/chapter/permanova/

Prep community data matrix, where rows are samples and columns are OTU/ASVs. I made this ahead of time and the file is labeled as axial_asv. 

Calculate distance matrix, in this case I'm using Bray Curtis. 

To run a PERMANOVA test you need both 1) an ASV table where rows = samples and columns = ASVs and 2)metadata DF where each row = sample. Before running adonis2(), ensure sample row from each table match exactly in order. 
```{r}
#Subset data for just one vent site. (This can not be done once a distance object is created). 
```{r}
#Subset data for just one vent site. (This can not be done once a distance object is created). 
#As figured out in previous steps (check_axial_asvs) some rows may not have a single ASV present. These rows must be removed or it will interfere with distance metrics.This was done ahead of time with check_axial_asvs.
#Remove row_sum column
check_axial_asvs <- axial_asv %>% mutate(row_sum = rowSums(select(., -sample))) %>% 
  filter(row_sum != 0)

#1 prep ASV table and create distance object
no_zero_asv_ASHES <- check_axial_asvs %>% select(-row_sum) %>% filter(grepl("ASHES", sample))

#Prep metadata table by filtering for ASHES vent site and ensuring sample rows match. Remember that samples with no asv were removed, so these also need to be removed from the metadata.
no_zero_asv_ASHES <- column_to_rownames(no_zero_asv_ASHES, "sample")
rownames(no_zero_asv_ASHES)

metadata_ASHES <- column_to_rownames(metadata_ASHES, "sample")
rownames(metadata_ASHES)

all(rownames(no_zero_asv_ASHES) == metadata_ASHES$sample)

no_zero_asv_ASHES <- rownames_to_column(no_zero_asv_ASHES, "sample")
rownames(no_zero_asv_ASHES)

no_zero_asv_ASHES <- no_zero_asv_ASHES %>% select(-"sample")

bray_curtis_axial <- vegdist(no_zero_asv_ASHES, method = "bray")

#Run PERMANOVA using adonis2() in vegan 
adonis_results_ASHES <- adonis2(bray_curtis_axial ~ DEPTH_CATEGORY, data = metadata_ASHES, permutations = 9999)

```


##PERMANOVA on International District Plume
```{r}
##Reminder about dataframe being used
check_axial_asvs <- axial_asv %>% mutate(row_sum = rowSums(select(., -sample))) %>% 
  filter(row_sum != 0)

#1 prep ASV table and create distance object
no_zero_asv_intl_dist <- check_axial_asvs %>% select(-row_sum) %>% filter(grepl("IntlDistrict|IntlDist", sample))

#Prep metadata table by filtering for International District site and ensuring sample rows match. Remember that samples with no asv were removed, so these also need to be removed from the metadata.
# Make sure your ASV table has sample names as a column
check_axial_asvs <- check_axial_asvs %>% column_to_rownames("sample")

metadata_intl_dist <- metadata_input %>% 
  filter(Location_Name == "International District") %>% filter(sample %in% rownames(check_axial_asvs))


#Remove sample column so that entire table is numeric
no_zero_asv_intl_dist <- no_zero_asv_intl_dist %>% select(-"sample")

bray_curtis_axial_intlDist <- vegdist(no_zero_asv_intl_dist, method = "bray")

#Run PERMANOVA using adonis2() in vegan 
adonis_results_intl_dist <- adonis2(
  bray_curtis_axial_intlDist ~ DEPTH_CATEGORY, 
  data = metadata_intl_dist, 
  permutations = 9999)

```


```{r}

library(tidyverse)
library(vegan)

# Prepare ASV table


# Add a row_sum column to remove zero-count samples
check_axial_asvs <- axial_asv %>%
  mutate(row_sum = rowSums(select(., -sample))) %>%
  filter(row_sum != 0)

# Set proper rownames and remove the sample column
rownames(check_axial_asvs) <- check_axial_asvs$sample
check_axial_asvs <- check_axial_asvs %>% select(-sample, -row_sum)

# Prepare Metadata table

# Ensure metadata sample names match ASV rownames
#metadata_input <- metadata_input %>% 
  #mutate(NEW_FASTQ_NAME = str_trim(NEW_FASTQ_NAME))


# Filter ASV + Metadata for ASHES
samples_ASHES <- metadata_input %>%
  filter(Location_Name == "ASHES") %>%
  pull(sample)

# Subset ASV table and metadata
asv_ASHES <- check_axial_asvs[samples_ASHES, ]
metadata_ASHES <- metadata_input %>%
  filter(sample %in% rownames(asv_ASHES)) %>%
  mutate(DEPTH_CATEGORY = factor(DEPTH_CATEGORY))

# Filter ASV + Metadata for International District

samples_intl <- metadata_input %>%
  filter(Location_Name == "International District") %>%
  pull(sample)

asv_intl <- check_axial_asvs[samples_intl, ]
metadata_intl <- metadata_input %>%
  filter(sample %in% rownames(asv_intl)) %>%
  mutate(DEPTH_CATEGORY = factor(DEPTH_CATEGORY))

# Bray-Curtis Distance Matrices
bray_ASHES <- vegdist(asv_ASHES, method = "bray")
bray_intl <- vegdist(asv_intl, method = "bray")


#  PERMANOVA

# Only run if DEPTH_CATEGORY has >= 2 levels
if(length(unique(metadata_ASHES$DEPTH_CATEGORY)) > 1){
  adonis_ASHES <- adonis2(bray_ASHES ~ DEPTH_CATEGORY, data = metadata_ASHES, permutations = 9999)
}

if(length(unique(metadata_intl$DEPTH_CATEGORY)) > 1){
  adonis_intl <- adonis2(bray_intl ~ DEPTH_CATEGORY, data = metadata_intl, permutations = 9999)
}

```


